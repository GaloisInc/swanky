default:
  tags: [docker-nix]
  image: "bitnami/git:2.42.0-debian-11-r20"
  interruptible: true
  before_script:
    - mkdir -p -m 0755 /nix/var/log/nix/drvs
    - mkdir -p -m 0755 /nix/var/nix/gcroots
    - mkdir -p -m 0755 /nix/var/nix/profiles
    - mkdir -p -m 0755 /nix/var/nix/temproots
    - mkdir -p -m 0755 /nix/var/nix/userpool
    - mkdir -p -m 1777 /nix/var/nix/gcroots/per-user
    - mkdir -p -m 1777 /nix/var/nix/profiles/per-user
    - mkdir -p -m 0755 /nix/var/nix/profiles/per-user/root
    - export NIX_PATH="nixpkgs=$PWD/etc/nix/pkgs.nix"
    - export PATH="/nix/var/nix/profiles/default/bin/:$PATH"

variables:
  GIT_STRATEGY: fetch
  NIX_REMOTE: daemon
  TMPDIR: /tmp

normal-test:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
  script:
    - ./etc/ci/swanky_releasing_check.sh
    - ./swanky ci --cache-dir=/var/lib/swanky-sccache/ quick

nightly-test:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: on_success
  script:
    - ./swanky ci --cache-dir=/var/lib/swanky-sccache/ nightly
