default:
  tags: [docker-nix]
  image: "debian/snapshot:stable-20230814"
  interruptible: true
  before_script:
    - mkdir -p -m 0755 /nix/var/log/nix/drvs
    - mkdir -p -m 0755 /nix/var/nix/gcroots
    - mkdir -p -m 0755 /nix/var/nix/profiles
    - mkdir -p -m 0755 /nix/var/nix/temproots
    - mkdir -p -m 0755 /nix/var/nix/userpool
    - mkdir -p -m 1777 /nix/var/nix/gcroots/per-user
    - mkdir -p -m 1777 /nix/var/nix/profiles/per-user
    - mkdir -p -m 0755 /nix/var/nix/profiles/per-user/root
    - export NIX_PATH="nixpkgs=$PWD/etc/nix/pkgs.nix"
    - export PATH="/nix/var/nix/profiles/default/bin/:$PATH"

variables:
  GIT_STRATEGY: clone
  NIX_REMOTE: daemon

normal-test:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
  script:
    - ./swanky ci --cache-dir=/var/lib/swanky-sccache/ quick

nightly-test:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: on_success
  script:
    - ./swanky ci --cache-dir=/var/lib/swanky-sccache/ nightly
